generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// Admin Settings Model
///
/// IMPORTANT: This model stores settings as JSON with specific validation requirements:
///
/// FORMULA-001: teacherStudentRatio
/// - MUST be stored as DECIMAL between 0 and 1 (e.g., 0.0714 for 7.14%)
/// - Valid range: 0.0-1.0
/// - Example: 0.0714 means 1 teacher per 14 students (1 / 14 = 0.0714)
/// - INVALID: 7.14 (percentage format - must be converted to decimal)
/// - See API validation in /api/admin/settings for enforcement
///
/// Transition Period Settings (2025-2027):
/// - transitionCapacityCap: Maximum student enrollment during transition (physical constraint)
/// - transitionRentAdjustmentPercent: Rent adjustment from 2024 baseline (e.g., 10.0 = +10%)
/// - transitionStaffCostBase2024: Base year (2024) staff costs for growth calculations
/// - transitionRentBase2024: Base year (2024) rent for growth calculations
model admin_settings {
  id                              String   @id @default(uuid())
  key                             String   @unique
  /// JSON value - see model documentation for validation requirements per key
  value                           Json
  updatedAt                       DateTime @updatedAt
  updatedBy                       String?

  // Transition period global settings (2025-2027)
  transitionCapacityCap           Int?     @default(1850) @map("transition_capacity_cap")
  transitionRentAdjustmentPercent Decimal? @default(10.0) @db.Decimal(5, 2) @map("transition_rent_adjustment_percent")

  // Base year values for transition calculations (fetched from historical_actuals year 2024)
  transitionStaffCostBase2024     Decimal? @db.Decimal(15, 2) @map("transition_staff_cost_base_2024")
  transitionRentBase2024          Decimal? @db.Decimal(15, 2) @map("transition_rent_base_2024")

  @@index([key])
}

model audit_logs {
  id         String     @id @default(uuid())
  action     String
  userId     String
  entityType EntityType
  entityId   String
  metadata   Json?
  timestamp  DateTime   @default(now())
  ipAddress  String?
  userAgent  String?
  users      users      @relation(fields: [userId], references: [id])

  @@index([action, timestamp])
  @@index([entityType, entityId])
  @@index([userId, timestamp])
}

model capex_items {
  id          String        @id @default(uuid())
  versionId   String
  ruleId      String?
  year        Int
  category    CapexCategory
  amount      Decimal       @db.Decimal(15, 2)
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  versions    versions      @relation(fields: [versionId], references: [id], onDelete: Cascade)
  capex_rules capex_rules?  @relation(fields: [ruleId], references: [id])

  @@index([versionId, year])
  @@index([year])
  @@index([ruleId])
  @@index([category])
}

model capex_rules {
  id            String        @id @default(uuid())
  versionId     String
  category      CapexCategory
  cycleYears    Int
  baseCost      Decimal       @db.Decimal(15, 2)
  startingYear  Int
  inflationIndex String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  versions      versions      @relation(fields: [versionId], references: [id], onDelete: Cascade)
  capex_items   capex_items[]

  @@index([versionId])
}

model curriculum_plans {
  id                      String         @id @default(uuid())
  versionId               String
  curriculumType          CurriculumType
  capacity                Int
  tuitionBase             Decimal        @db.Decimal(15, 2)
  cpiFrequency            Int
  studentsProjection      Json
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  teacherRatio            Decimal?       @db.Decimal(5, 4)
  nonTeacherRatio         Decimal?       @db.Decimal(5, 4)
  teacherMonthlySalary    Decimal?       @db.Decimal(12, 2)
  nonTeacherMonthlySalary Decimal?       @db.Decimal(12, 2)
  tuitionGrowthRate       Decimal?       @db.Decimal(5, 4)
  versions                versions       @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, curriculumType])
  @@index([versionId])
  @@index([curriculumType])
}

model opex_sub_accounts {
  id               String   @id @default(uuid())
  versionId        String
  subAccountName   String
  percentOfRevenue Decimal? @db.Decimal(5, 2)
  isFixed          Boolean
  fixedAmount      Decimal? @db.Decimal(15, 2)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  versions         versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, subAccountName])
  @@index([versionId])
}

model rent_plans {
  id         String    @id @default(uuid())
  versionId  String    @unique
  rentModel  RentModel
  parameters Json
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  versions   versions  @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([rentModel])
}

model reports {
  id          String       @id @default(uuid())
  versionId   String?
  reportType  ReportType
  format      ReportFormat
  fileName    String
  filePath    String
  fileSize    Int
  downloadUrl String
  expiresAt   DateTime
  generatedBy String
  generatedAt DateTime     @default(now())
  metadata    Json?
  deletedAt   DateTime?
  users       users        @relation(fields: [generatedBy], references: [id])
  versions    versions?    @relation(fields: [versionId], references: [id])

  @@index([expiresAt])
  @@index([format])
  @@index([generatedAt])
  @@index([generatedBy])
  @@index([reportType])
  @@index([versionId])
}

model tuition_simulations {
  id          String   @id @default(uuid())
  versionId   String
  name        String
  adjustments Json
  createdBy   String
  createdAt   DateTime @default(now())
  users       users    @relation(fields: [createdBy], references: [id])
  versions    versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([createdBy])
  @@index([versionId])
}

model users {
  id                  String                @id @default(uuid())
  email               String                @unique
  emailVerified       DateTime?
  name                String?
  password            String?
  role                Role                  @default(VIEWER)
  image               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  lastLoginAt         DateTime?
  audit_logs          audit_logs[]
  reports             reports[]
  tuition_simulations tuition_simulations[]
  versions            versions[]

  @@index([email])
  @@index([role])
}

model versions {
  id                      String                   @id @default(uuid())
  name                    String
  description             String?
  mode                    VersionMode
  status                  VersionStatus            @default(DRAFT)
  createdBy               String
  basedOnId               String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  lockedAt                DateTime?
  lockedBy                String?
  lockReason              String?
  transitionCapacity      Int?                     @default(1850)
  capex_items             capex_items[]
  capex_rules             capex_rules[]
  curriculum_plans        curriculum_plans[]
  opex_sub_accounts       opex_sub_accounts[]
  rent_plans              rent_plans?
  reports                 reports[]
  tuition_simulations     tuition_simulations[]
  other_revenue_items     other_revenue_items[]
  balance_sheet_settings  balance_sheet_settings?
  historical_actuals      historical_actuals[]
  versions                versions?                @relation("versionsToversions", fields: [basedOnId], references: [id])
  other_versions          versions[]               @relation("versionsToversions")
  users                   users                    @relation(fields: [createdBy], references: [id])

  @@unique([name, createdBy])
  @@index([createdBy])
  @@index([mode])
  @@index([status, createdAt])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([basedOnId])
}

model other_revenue_items {
  id        String   @id @default(uuid())
  versionId String
  year      Int
  amount    Decimal  @default(0) @db.Decimal(15, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  versions  versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, year])
  @@index([versionId, year])
  @@index([year])
}

model balance_sheet_settings {
  id            String   @id @default(uuid())
  versionId     String   @unique
  startingCash  Decimal  @default(0) @db.Decimal(15, 2)
  openingEquity Decimal  @default(0) @db.Decimal(15, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  versions      versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId])
}

model historical_actuals {
  id        String   @id @default(uuid())
  versionId String
  year      Int

  // P&L - Revenue
  tuitionFrenchCurriculum Decimal @default(0) @db.Decimal(15, 2)
  tuitionIB               Decimal @default(0) @db.Decimal(15, 2)
  otherIncome             Decimal @default(0) @db.Decimal(15, 2)
  totalRevenues           Decimal @default(0) @db.Decimal(15, 2)

  // P&L - Expenses
  salariesAndRelatedCosts Decimal @default(0) @db.Decimal(15, 2)
  schoolRent              Decimal @default(0) @db.Decimal(15, 2)
  otherExpenses           Decimal @default(0) @db.Decimal(15, 2)
  totalOperatingExpenses  Decimal @default(0) @db.Decimal(15, 2)

  // P&L - Other
  depreciationAmortization Decimal @default(0) @db.Decimal(15, 2)
  interestIncome           Decimal @default(0) @db.Decimal(15, 2)
  interestExpenses         Decimal @default(0) @db.Decimal(15, 2)
  netResult                Decimal @default(0) @db.Decimal(15, 2)

  // Balance Sheet - Assets
  cashOnHandAndInBank              Decimal @default(0) @db.Decimal(15, 2)
  accountsReceivableAndOthers      Decimal @default(0) @db.Decimal(15, 2)
  totalCurrentAssets               Decimal @default(0) @db.Decimal(15, 2)
  tangibleIntangibleAssetsGross    Decimal @default(0) @db.Decimal(15, 2)
  accumulatedDepreciationAmort     Decimal @default(0) @db.Decimal(15, 2)
  nonCurrentAssets                 Decimal @default(0) @db.Decimal(15, 2)
  totalAssets                      Decimal @default(0) @db.Decimal(15, 2)

  // Balance Sheet - Liabilities
  accountsPayable         Decimal @default(0) @db.Decimal(15, 2)
  deferredIncome          Decimal @default(0) @db.Decimal(15, 2)
  totalCurrentLiabilities Decimal @default(0) @db.Decimal(15, 2)
  provisions              Decimal @default(0) @db.Decimal(15, 2)
  totalLiabilities        Decimal @default(0) @db.Decimal(15, 2)

  // Balance Sheet - Equity
  retainedEarnings Decimal @default(0) @db.Decimal(15, 2)
  equity           Decimal @default(0) @db.Decimal(15, 2)

  // Cash Flow - Operating Activities
  cfNetResult                    Decimal @default(0) @db.Decimal(15, 2)
  cfAccountsReceivable           Decimal @default(0) @db.Decimal(15, 2)
  cfPrepaidExpenses              Decimal @default(0) @db.Decimal(15, 2)
  cfLoans                        Decimal @default(0) @db.Decimal(15, 2)
  cfIntangibleAssets             Decimal @default(0) @db.Decimal(15, 2)
  cfAccountsPayable              Decimal @default(0) @db.Decimal(15, 2)
  cfAccruedExpenses              Decimal @default(0) @db.Decimal(15, 2)
  cfDeferredIncome               Decimal @default(0) @db.Decimal(15, 2)
  cfProvisions                   Decimal @default(0) @db.Decimal(15, 2)
  cfDepreciation                 Decimal @default(0) @db.Decimal(15, 2)
  netCashFromOperatingActivities Decimal @default(0) @db.Decimal(15, 2)

  // Cash Flow - Investing Activities
  cfAdditionsFixedAssets         Decimal @default(0) @db.Decimal(15, 2)
  netCashFromInvestingActivities Decimal @default(0) @db.Decimal(15, 2)

  // Cash Flow - Financing Activities
  cfChangesInFundBalance         Decimal @default(0) @db.Decimal(15, 2)
  netCashFromFinancingActivities Decimal @default(0) @db.Decimal(15, 2)

  // Cash Flow - Summary
  netIncreaseDecreaseCash Decimal @default(0) @db.Decimal(15, 2)
  cashBeginningOfPeriod   Decimal @default(0) @db.Decimal(15, 2)
  cashEndOfPeriod         Decimal @default(0) @db.Decimal(15, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  versions  versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, year])
  @@index([versionId])
  @@index([year])
}

/// Transition Year Data Model (2025-2027)
///
/// Purpose: Store admin-adjustable parameters for transition period planning
/// - Year-specific enrollment targets (subject to capacity cap in admin_settings)
/// - Staff cost baselines (with CPI growth applied in calculations)
/// - Period: TRANSITION years only (2025-2027)
///
/// Business Rules:
/// - CRITICAL: IB curriculum is NOT active during transition (2025-2027) - only FR operates!
/// - averageTuitionPerStudent represents FR curriculum tuition only
/// - Total enrollment per year (no FR/IB split needed for transition)
/// - Revenue calculation: targetEnrollment Ã— averageTuitionPerStudent + otherRevenue
/// - Staff costs and rent use growth percentages from 2024 base year
model transition_year_data {
  id               String   @id @default(uuid())
  year             Int      @unique
  targetEnrollment Int      @map("target_enrollment")
  staffCostBase    Decimal  @db.Decimal(15, 2) @map("staff_cost_base")
  notes            String?

  // Revenue components
  averageTuitionPerStudent Decimal? @db.Decimal(15, 2) @map("average_tuition_per_student")
  otherRevenue            Decimal? @default(0) @db.Decimal(15, 2) @map("other_revenue")

  // Operating expenses
  opex                    Decimal? @db.Decimal(15, 2) @map("opex")

  // Growth percentages (from 2024 base year)
  staffCostGrowthPercent  Decimal? @db.Decimal(5, 2) @map("staff_cost_growth_percent")
  rentGrowthPercent       Decimal? @db.Decimal(5, 2) @map("rent_growth_percent")

  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([year])
}

enum CapexCategory {
  BUILDING
  TECHNOLOGY
  EQUIPMENT
  FURNITURE
  VEHICLES
  OTHER
}

enum CurriculumType {
  FR
  IB
}

enum EntityType {
  VERSION
  CURRICULUM
  RENT
  CAPEX
  OPEX
  USER
  SETTING
  REPORT
  TRANSITION_YEAR
}

enum RentModel {
  FIXED_ESCALATION
  REVENUE_SHARE
  PARTNER_MODEL
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
}

enum ReportType {
  EXECUTIVE_SUMMARY
  FINANCIAL_DETAIL
  COMPARISON
}

enum Role {
  ADMIN
  PLANNER
  VIEWER
}

enum VersionMode {
  RELOCATION_2028
  HISTORICAL_BASELINE
}

enum VersionStatus {
  DRAFT
  READY
  APPROVED
  LOCKED
}
