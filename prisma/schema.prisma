generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model admin_settings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index([key])
}

model audit_logs {
  id         String     @id @default(uuid())
  action     String
  userId     String
  entityType EntityType
  entityId   String
  metadata   Json?
  timestamp  DateTime   @default(now())
  ipAddress  String?
  userAgent  String?
  users      users      @relation(fields: [userId], references: [id])

  @@index([action, timestamp])
  @@index([entityType, entityId])
  @@index([userId, timestamp])
}

model capex_items {
  id          String        @id @default(uuid())
  versionId   String
  ruleId      String?
  year        Int
  category    CapexCategory
  amount      Decimal       @db.Decimal(15, 2)
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  versions    versions      @relation(fields: [versionId], references: [id], onDelete: Cascade)
  capex_rules capex_rules?  @relation(fields: [ruleId], references: [id])

  @@index([versionId, year])
}

model capex_rules {
  id            String        @id @default(uuid())
  versionId     String
  category      CapexCategory
  cycleYears    Int
  baseCost      Decimal       @db.Decimal(15, 2)
  startingYear  Int
  inflationIndex String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  versions      versions      @relation(fields: [versionId], references: [id], onDelete: Cascade)
  capex_items   capex_items[]

  @@index([versionId])
}

model curriculum_plans {
  id                      String         @id @default(uuid())
  versionId               String
  curriculumType          CurriculumType
  capacity                Int
  tuitionBase             Decimal        @db.Decimal(15, 2)
  cpiFrequency            Int
  studentsProjection      Json
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  teacherRatio            Decimal?       @db.Decimal(5, 4)
  nonTeacherRatio         Decimal?       @db.Decimal(5, 4)
  teacherMonthlySalary    Decimal?       @db.Decimal(12, 2)
  nonTeacherMonthlySalary Decimal?       @db.Decimal(12, 2)
  tuitionGrowthRate       Decimal?       @db.Decimal(5, 4)
  versions                versions       @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, curriculumType])
  @@index([versionId])
}

model opex_sub_accounts {
  id               String   @id @default(uuid())
  versionId        String
  subAccountName   String
  percentOfRevenue Decimal? @db.Decimal(5, 2)
  isFixed          Boolean
  fixedAmount      Decimal? @db.Decimal(15, 2)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  versions         versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, subAccountName])
  @@index([versionId])
}

model rent_plans {
  id         String    @id @default(uuid())
  versionId  String    @unique
  rentModel  RentModel
  parameters Json
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  versions   versions  @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([rentModel])
}

model reports {
  id          String       @id @default(uuid())
  versionId   String?
  reportType  ReportType
  format      ReportFormat
  fileName    String
  filePath    String
  fileSize    Int
  downloadUrl String
  expiresAt   DateTime
  generatedBy String
  generatedAt DateTime     @default(now())
  metadata    Json?
  deletedAt   DateTime?
  users       users        @relation(fields: [generatedBy], references: [id])
  versions    versions?    @relation(fields: [versionId], references: [id])

  @@index([expiresAt])
  @@index([format])
  @@index([generatedAt])
  @@index([generatedBy])
  @@index([reportType])
  @@index([versionId])
}

model tuition_simulations {
  id          String   @id @default(uuid())
  versionId   String
  name        String
  adjustments Json
  createdBy   String
  createdAt   DateTime @default(now())
  users       users    @relation(fields: [createdBy], references: [id])
  versions    versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([createdBy])
  @@index([versionId])
}

model users {
  id                  String                @id @default(uuid())
  email               String                @unique
  emailVerified       DateTime?
  name                String?
  password            String?
  role                Role                  @default(VIEWER)
  image               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  lastLoginAt         DateTime?
  audit_logs          audit_logs[]
  reports             reports[]
  tuition_simulations tuition_simulations[]
  versions            versions[]

  @@index([email])
  @@index([role])
}

model versions {
  id                      String                   @id @default(uuid())
  name                    String
  description             String?
  mode                    VersionMode
  status                  VersionStatus            @default(DRAFT)
  createdBy               String
  basedOnId               String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  lockedAt                DateTime?
  lockedBy                String?
  lockReason              String?
  transitionCapacity      Int?                     @default(1850)
  capex_items             capex_items[]
  capex_rules             capex_rules[]
  curriculum_plans        curriculum_plans[]
  opex_sub_accounts       opex_sub_accounts[]
  rent_plans              rent_plans?
  reports                 reports[]
  tuition_simulations     tuition_simulations[]
  other_revenue_items     other_revenue_items[]
  balance_sheet_settings  balance_sheet_settings?
  historical_actuals      historical_actuals[]
  versions                versions?                @relation("versionsToversions", fields: [basedOnId], references: [id])
  other_versions          versions[]               @relation("versionsToversions")
  users                   users                    @relation(fields: [createdBy], references: [id])

  @@unique([name, createdBy])
  @@index([createdBy])
  @@index([mode])
  @@index([status, createdAt])
}

model other_revenue_items {
  id        String   @id @default(uuid())
  versionId String
  year      Int
  amount    Decimal  @default(0) @db.Decimal(15, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  versions  versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, year])
  @@index([versionId, year])
}

model balance_sheet_settings {
  id            String   @id @default(uuid())
  versionId     String   @unique
  startingCash  Decimal  @default(0) @db.Decimal(15, 2)
  openingEquity Decimal  @default(0) @db.Decimal(15, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  versions      versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId])
}

model historical_actuals {
  id        String   @id @default(uuid())
  versionId String
  year      Int

  // P&L - Revenue
  tuitionFrenchCurriculum Decimal @default(0) @db.Decimal(15, 2)
  tuitionIB               Decimal @default(0) @db.Decimal(15, 2)
  otherIncome             Decimal @default(0) @db.Decimal(15, 2)
  totalRevenues           Decimal @default(0) @db.Decimal(15, 2)

  // P&L - Expenses
  salariesAndRelatedCosts Decimal @default(0) @db.Decimal(15, 2)
  schoolRent              Decimal @default(0) @db.Decimal(15, 2)
  otherExpenses           Decimal @default(0) @db.Decimal(15, 2)
  totalOperatingExpenses  Decimal @default(0) @db.Decimal(15, 2)

  // P&L - Other
  depreciationAmortization Decimal @default(0) @db.Decimal(15, 2)
  interestIncome           Decimal @default(0) @db.Decimal(15, 2)
  interestExpenses         Decimal @default(0) @db.Decimal(15, 2)
  netResult                Decimal @default(0) @db.Decimal(15, 2)

  // Balance Sheet - Assets
  cashOnHandAndInBank              Decimal @default(0) @db.Decimal(15, 2)
  accountsReceivableAndOthers      Decimal @default(0) @db.Decimal(15, 2)
  totalCurrentAssets               Decimal @default(0) @db.Decimal(15, 2)
  tangibleIntangibleAssetsGross    Decimal @default(0) @db.Decimal(15, 2)
  accumulatedDepreciationAmort     Decimal @default(0) @db.Decimal(15, 2)
  nonCurrentAssets                 Decimal @default(0) @db.Decimal(15, 2)
  totalAssets                      Decimal @default(0) @db.Decimal(15, 2)

  // Balance Sheet - Liabilities
  accountsPayable         Decimal @default(0) @db.Decimal(15, 2)
  deferredIncome          Decimal @default(0) @db.Decimal(15, 2)
  totalCurrentLiabilities Decimal @default(0) @db.Decimal(15, 2)
  provisions              Decimal @default(0) @db.Decimal(15, 2)
  totalLiabilities        Decimal @default(0) @db.Decimal(15, 2)

  // Balance Sheet - Equity
  retainedEarnings Decimal @default(0) @db.Decimal(15, 2)
  equity           Decimal @default(0) @db.Decimal(15, 2)

  // Cash Flow - Operating Activities
  cfNetResult                    Decimal @default(0) @db.Decimal(15, 2)
  cfAccountsReceivable           Decimal @default(0) @db.Decimal(15, 2)
  cfPrepaidExpenses              Decimal @default(0) @db.Decimal(15, 2)
  cfLoans                        Decimal @default(0) @db.Decimal(15, 2)
  cfIntangibleAssets             Decimal @default(0) @db.Decimal(15, 2)
  cfAccountsPayable              Decimal @default(0) @db.Decimal(15, 2)
  cfAccruedExpenses              Decimal @default(0) @db.Decimal(15, 2)
  cfDeferredIncome               Decimal @default(0) @db.Decimal(15, 2)
  cfProvisions                   Decimal @default(0) @db.Decimal(15, 2)
  cfDepreciation                 Decimal @default(0) @db.Decimal(15, 2)
  netCashFromOperatingActivities Decimal @default(0) @db.Decimal(15, 2)

  // Cash Flow - Investing Activities
  cfAdditionsFixedAssets         Decimal @default(0) @db.Decimal(15, 2)
  netCashFromInvestingActivities Decimal @default(0) @db.Decimal(15, 2)

  // Cash Flow - Financing Activities
  cfChangesInFundBalance         Decimal @default(0) @db.Decimal(15, 2)
  netCashFromFinancingActivities Decimal @default(0) @db.Decimal(15, 2)

  // Cash Flow - Summary
  netIncreaseDecreaseCash Decimal @default(0) @db.Decimal(15, 2)
  cashBeginningOfPeriod   Decimal @default(0) @db.Decimal(15, 2)
  cashEndOfPeriod         Decimal @default(0) @db.Decimal(15, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  versions  versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, year])
  @@index([versionId])
}

enum CapexCategory {
  BUILDING
  TECHNOLOGY
  EQUIPMENT
  FURNITURE
  VEHICLES
  OTHER
}

enum CurriculumType {
  FR
  IB
}

enum EntityType {
  VERSION
  CURRICULUM
  RENT
  CAPEX
  OPEX
  USER
  SETTING
  REPORT
}

enum RentModel {
  FIXED_ESCALATION
  REVENUE_SHARE
  PARTNER_MODEL
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
}

enum ReportType {
  EXECUTIVE_SUMMARY
  FINANCIAL_DETAIL
  COMPARISON
}

enum Role {
  ADMIN
  PLANNER
  VIEWER
}

enum VersionMode {
  RELOCATION_2028
  HISTORICAL_BASELINE
}

enum VersionStatus {
  DRAFT
  READY
  APPROVED
  LOCKED
}
