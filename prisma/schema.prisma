generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model admin_settings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index([key])
}

model audit_logs {
  id         String     @id @default(uuid())
  action     String
  userId     String
  entityType EntityType
  entityId   String
  metadata   Json?
  timestamp  DateTime   @default(now())
  ipAddress  String?
  userAgent  String?
  users      users      @relation(fields: [userId], references: [id])

  @@index([action, timestamp])
  @@index([entityType, entityId])
  @@index([userId, timestamp])
}

model capex_items {
  id          String        @id @default(uuid())
  versionId   String
  ruleId      String?
  year        Int
  category    CapexCategory
  amount      Decimal       @db.Decimal(15, 2)
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  versions    versions      @relation(fields: [versionId], references: [id], onDelete: Cascade)
  capex_rules capex_rules?  @relation(fields: [ruleId], references: [id])

  @@index([versionId, year])
}

model capex_rules {
  id            String        @id @default(uuid())
  versionId     String
  category      CapexCategory
  cycleYears    Int
  baseCost      Decimal       @db.Decimal(15, 2)
  startingYear  Int
  inflationIndex String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  versions      versions      @relation(fields: [versionId], references: [id], onDelete: Cascade)
  capex_items   capex_items[]

  @@index([versionId])
}

model curriculum_plans {
  id                      String         @id @default(uuid())
  versionId               String
  curriculumType          CurriculumType
  capacity                Int
  tuitionBase             Decimal        @db.Decimal(15, 2)
  cpiFrequency            Int
  studentsProjection      Json
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  teacherRatio            Decimal?       @db.Decimal(5, 4)
  nonTeacherRatio         Decimal?       @db.Decimal(5, 4)
  teacherMonthlySalary    Decimal?       @db.Decimal(12, 2)
  nonTeacherMonthlySalary Decimal?       @db.Decimal(12, 2)
  tuitionGrowthRate       Decimal?       @db.Decimal(5, 4)
  versions                versions       @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, curriculumType])
  @@index([versionId])
}

model opex_sub_accounts {
  id               String   @id @default(uuid())
  versionId        String
  subAccountName   String
  percentOfRevenue Decimal? @db.Decimal(5, 2)
  isFixed          Boolean
  fixedAmount      Decimal? @db.Decimal(15, 2)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  versions         versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@unique([versionId, subAccountName])
  @@index([versionId])
}

model rent_plans {
  id         String    @id @default(uuid())
  versionId  String    @unique
  rentModel  RentModel
  parameters Json
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  versions   versions  @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([rentModel])
}

model reports {
  id          String       @id @default(uuid())
  versionId   String?
  reportType  ReportType
  format      ReportFormat
  fileName    String
  filePath    String
  fileSize    Int
  downloadUrl String
  expiresAt   DateTime
  generatedBy String
  generatedAt DateTime     @default(now())
  metadata    Json?
  deletedAt   DateTime?
  users       users        @relation(fields: [generatedBy], references: [id])
  versions    versions?    @relation(fields: [versionId], references: [id])

  @@index([expiresAt])
  @@index([format])
  @@index([generatedAt])
  @@index([generatedBy])
  @@index([reportType])
  @@index([versionId])
}

model tuition_simulations {
  id          String   @id @default(uuid())
  versionId   String
  name        String
  adjustments Json
  createdBy   String
  createdAt   DateTime @default(now())
  users       users    @relation(fields: [createdBy], references: [id])
  versions    versions @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([createdBy])
  @@index([versionId])
}

model users {
  id                  String                @id @default(uuid())
  email               String                @unique
  emailVerified       DateTime?
  name                String?
  password            String?
  role                Role                  @default(VIEWER)
  image               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  lastLoginAt         DateTime?
  audit_logs          audit_logs[]
  reports             reports[]
  tuition_simulations tuition_simulations[]
  versions            versions[]

  @@index([email])
  @@index([role])
}

model versions {
  id                  String                @id @default(uuid())
  name                String
  description         String?
  mode                VersionMode
  status              VersionStatus         @default(DRAFT)
  createdBy           String
  basedOnId           String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  lockedAt            DateTime?
  lockedBy            String?
  lockReason          String?
  capex_items         capex_items[]
  capex_rules         capex_rules[]
  curriculum_plans    curriculum_plans[]
  opex_sub_accounts   opex_sub_accounts[]
  rent_plans          rent_plans?
  reports             reports[]
  tuition_simulations tuition_simulations[]
  versions            versions?             @relation("versionsToversions", fields: [basedOnId], references: [id])
  other_versions      versions[]            @relation("versionsToversions")
  users               users                 @relation(fields: [createdBy], references: [id])

  @@unique([name, createdBy])
  @@index([createdBy])
  @@index([mode])
  @@index([status, createdAt])
}

enum CapexCategory {
  BUILDING
  TECHNOLOGY
  EQUIPMENT
  FURNITURE
  VEHICLES
  OTHER
}

enum CurriculumType {
  FR
  IB
}

enum EntityType {
  VERSION
  CURRICULUM
  RENT
  CAPEX
  OPEX
  USER
  SETTING
  REPORT
}

enum RentModel {
  FIXED_ESCALATION
  REVENUE_SHARE
  PARTNER_MODEL
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
}

enum ReportType {
  EXECUTIVE_SUMMARY
  FINANCIAL_DETAIL
  COMPARISON
}

enum Role {
  ADMIN
  PLANNER
  VIEWER
}

enum VersionMode {
  RELOCATION_2028
  HISTORICAL_BASELINE
}

enum VersionStatus {
  DRAFT
  READY
  APPROVED
  LOCKED
}
