# Capex Auto-Item Deletion Fix - Implementation Roadmap

**Date:** November 17, 2025  
**Issue:** Auto-generated Capex items should not be deletable individually  
**Status:** üìã **READY FOR IMPLEMENTATION**  
**Priority:** üü¢ **LOW** (Simplification - mostly verification)

---

## üìã Requirements Clarification

### What You Want

1. **Auto Re-investment Rule Behavior:**
   - ‚úÖ Rule generates recurring items based on cycle years (e.g., every 7 years)
   - ‚úÖ If user **deletes the RULE**, all auto-generated items should be deleted
   - ‚ùå **NO possibility to delete individual auto items** (simplification)

2. **Manual Items Behavior:**
   - ‚úÖ Manual items are **ADDITIVE** (not overrides)
   - ‚úÖ If auto item exists: Year 2035, FURNITURE, 5M SAR
   - ‚úÖ And manual item exists: Year 2035, FURNITURE, 3M SAR
   - ‚úÖ **Both should exist** (total = 8M SAR for that year/category)
   - ‚úÖ No conflict resolution needed

3. **Current Problem:**
   - ‚ùå User might be able to delete individual auto items (should not be possible)
   - ‚ùå If auto items are deleted, they reappear when rule recalculates
   - ‚úÖ **Solution: Prevent deletion of individual auto items entirely**

---

## üéØ Solution Overview

### Core Concept

**Prevent deletion of individual auto items:**
- Auto items should NOT be deletable individually
- Only way to remove auto items: Delete the entire rule
- UI should not show delete button on auto items
- API should reject attempts to delete auto items individually
- Manual items remain additive (no changes needed)

### Simplification Benefits

- ‚úÖ **No schema changes needed** (no suppressed years tracking)
- ‚úÖ **No complex logic** (no filtering during recalculation)
- ‚úÖ **Clear user experience** (delete rule = delete all auto items)
- ‚úÖ **Simple implementation** (mostly verification and enforcement)

---

## üîç Current Behavior Analysis

### Current Flow (Problematic)

```
1. User creates rule: FURNITURE, 7-year cycle, starting 2028
   ‚Üì
2. System generates: 2028, 2035, 2042, 2049, 2056
   ‚Üì
3. User attempts to delete items for 2035 and 2042
   ‚Üì
4. Issue: Should NOT be possible to delete individual auto items
   ‚Üì
5. If somehow deleted (e.g., via API), items reappear when rule recalculates
```

### Desired Flow (After Fix)

```
1. User creates rule: FURNITURE, 7-year cycle, starting 2028
   ‚Üì
2. System generates: 2028, 2035, 2042, 2049, 2056
   ‚Üì
3. User wants to remove some auto items
   ‚Üì
4. Solution: User must delete the entire rule
   ‚Üì
5. If user deletes rule:
   - All auto items deleted (cascade delete)
   - Manual items remain
   ‚Üì
6. Result: Clear, simple behavior ‚úÖ
```

---

## üìù Implementation Roadmap

### Phase 1: Verify Current UI Behavior

#### Step 1.1: Check UI Delete Button Visibility

**File:** `components/versions/VersionDetail.tsx`

**Current Logic (Lines 1989-2016):**
```typescript
{!isAutoGenerated && (
  // Edit/Delete buttons only for manual items
)}
```

**Verification:**
- ‚úÖ Auto items should NOT show delete button (current behavior appears correct)
- ‚úÖ Only manual items should show delete button
- ‚ö†Ô∏è **Action Required:** Verify this is working correctly

**Expected Behavior:**
- Auto items: No delete button visible
- Manual items: Delete button visible

---

### Phase 2: Verify API Protection

#### Step 2.1: Check API Delete Endpoint Protection

**File:** `app/api/versions/[id]/route.ts`

**Current Logic (Lines 1015-1037):**
```typescript
// Update manual capex items if provided (only items with ruleId = null)
if (data.capexItems) {
  // Delete only existing manual capex items (where ruleId IS NULL)
  await prisma.capex_items.deleteMany({
    where: { versionId: id, ruleId: null },
  });
  
  // Create new/updated manual capex items (ruleId will be null)
  if (data.capexItems.length > 0) {
    await prisma.capex_items.createMany({
      data: data.capexItems.map((item: any) => ({
        versionId: id,
        year: item.year,
        category: item.category,
        amount: item.amount,
        description: item.description || null,
        ruleId: null, // Manual items have no ruleId
      })),
    });
  }
}
```

**Verification:**
- ‚úÖ API only deletes items where `ruleId IS NULL` (manual items)
- ‚úÖ API only creates items with `ruleId: null` (manual items)
- ‚ö†Ô∏è **Action Required:** Verify that auto items (ruleId IS NOT NULL) cannot be deleted via API

**Expected Behavior:**
- When `capexItems` array is sent in PATCH request:
  - Only manual items (ruleId = null) should be processed
  - Auto items (ruleId IS NOT NULL) should be ignored
  - Auto items should only be deleted when rule is deleted (cascade delete)

---

### Phase 3: Add API Protection (If Needed)

#### Step 3.1: Add Validation to Prevent Auto Item Deletion

**File:** `app/api/versions/[id]/route.ts`

**Current Logic (Lines 1015-1037):**
- Only processes items with `ruleId: null` (manual items)
- This is already correct, but we should add explicit validation

**Enhanced Logic:**
```typescript
// Update manual capex items if provided (only items with ruleId = null)
if (data.capexItems) {
  // CRITICAL: Filter out any items that have ruleId (auto items)
  // Only allow deletion/update of manual items (ruleId = null)
  const manualItemsOnly = data.capexItems.filter((item: any) => {
    // If item has ruleId, it's an auto item - reject it
    if (item.ruleId !== null && item.ruleId !== undefined) {
      console.warn(`Attempted to modify auto item ${item.id} - ignoring`);
      return false;
    }
    return true;
  });
  
  // Delete only existing manual capex items (where ruleId IS NULL)
  await prisma.capex_items.deleteMany({
    where: { versionId: id, ruleId: null },
  });
  
  // Create new/updated manual capex items (ruleId will be null)
  if (manualItemsOnly.length > 0) {
    await prisma.capex_items.createMany({
      data: manualItemsOnly.map((item: any) => ({
        versionId: id,
        year: item.year,
        category: item.category,
        amount: item.amount,
        description: item.description || null,
        ruleId: null, // Manual items have no ruleId
      })),
    });
  }
}
```

**Key Changes:**
1. Explicitly filter out auto items (ruleId IS NOT NULL)
2. Log warning if auto items are attempted to be modified
3. Only process manual items

---

### Phase 4: Verify UI Behavior

#### Step 4.1: Verify Delete Button Not Shown on Auto Items

**File:** `components/versions/VersionDetail.tsx`

**Current Logic (Lines 1989-2016):**
```typescript
{!isAutoGenerated && (
  // Edit/Delete buttons only for manual items
)}
```

**Verification:**
- ‚úÖ Auto items should NOT show delete button (current behavior appears correct)
- ‚úÖ Only manual items should show delete button
- ‚ö†Ô∏è **Action Required:** Verify this is working correctly in UI

**Expected Behavior:**
- Auto items: No delete button visible ‚úÖ
- Manual items: Delete button visible ‚úÖ

---

#### Step 4.2: Add Tooltip/Message for Auto Items

**File:** `components/versions/VersionDetail.tsx`

**Enhancement (Optional):**
```typescript
{isAutoGenerated && (
  <Tooltip>
    <TooltipTrigger>
      <Info className="h-4 w-4 text-muted-foreground" />
    </TooltipTrigger>
    <TooltipContent>
      Auto-generated item. Delete the rule to remove all auto items.
    </TooltipContent>
  </Tooltip>
)}
```

**Purpose:** Help users understand why auto items cannot be deleted individually

---

#### Step 4.3: Verify Rule Delete Handler

**File:** `components/versions/VersionDetail.tsx`

**Current Logic (Lines 925-967):**
```typescript
const handleCapexRuleDelete = async (id: string) => {
  // ... deletes rule and all auto items
};
```

**Verification:**
- ‚úÖ Current logic already deletes all auto items when rule is deleted
- ‚úÖ This is correct behavior (as per requirements)
- ‚úÖ No changes needed

---

### Phase 5: Add User Messaging (Optional Enhancement)

#### Step 5.1: Add Helpful Message in UI

**File:** `components/versions/VersionDetail.tsx`

**Enhancement (Optional):**
```typescript
<CardDescription>
  All capex items (auto-generated from rules + manual entries).
  <br />
  <span className="text-xs text-muted-foreground">
    Note: Auto-generated items cannot be deleted individually. Delete the rule to remove all auto items.
  </span>
</CardDescription>
```

**Purpose:** Inform users about the behavior upfront

---

## üìä Data Flow After Fix

### Scenario 1: User Attempts to Delete Auto Item

```
1. User sees auto item (Year 2035, FURNITURE) in table
   ‚Üì
2. User looks for delete button
   ‚Üì
3. No delete button visible (auto item)
   ‚Üì
4. User understands: Cannot delete individual auto items
   ‚Üì
5. Result: Clear UX, no confusion ‚úÖ
```

### Scenario 2: User Deletes Rule

```
1. User deletes rule
   ‚Üì
2. System:
   - Deletes rule from database
   - Cascade delete: All auto items deleted (ruleId = rule.id)
   - Manual items remain (ruleId = null)
   ‚Üì
3. Result: All auto items deleted, manual items remain ‚úÖ
```

### Scenario 3: Update Rule (Recalculation)

```
1. User updates rule (e.g., changes base cost)
   ‚Üì
2. System recalculates:
   - Deletes ALL auto items (where ruleId IS NOT NULL)
   - Regenerates ALL items based on rule
   ‚Üì
3. Result: All auto items regenerated (expected behavior) ‚úÖ
```

### Scenario 4: Manual Item + Auto Item (Same Year/Category)

```
1. Rule generates: Year 2035, FURNITURE, 5M SAR (auto)
   ‚Üì
2. User creates: Year 2035, FURNITURE, 3M SAR (manual)
   ‚Üì
3. Both items exist in table:
   - Auto: 2035, FURNITURE, 5M SAR (no delete button)
   - Manual: 2035, FURNITURE, 3M SAR (has delete button)
   ‚Üì
4. Total for 2035, FURNITURE: 8M SAR (additive) ‚úÖ
```

---

## üîç Key Implementation Details

### 1. UI Protection

**Key Principle:**
- Auto items should NOT show delete button
- Only manual items should show delete button
- Clear visual distinction between auto and manual items

**Code Pattern:**
```typescript
const isAutoGenerated = item.ruleId !== null && item.ruleId !== undefined;

{!isAutoGenerated && (
  // Only show delete button for manual items
  <Button onClick={() => handleCapexDelete(item.id)}>
    <Trash2 />
  </Button>
)}
```

---

### 2. API Protection

**Key Principle:**
- API should reject attempts to delete/modify auto items
- Only process manual items (ruleId = null)
- Log warnings if auto items are attempted to be modified

**Code Pattern:**
```typescript
// Filter out auto items
const manualItemsOnly = data.capexItems.filter((item: any) => {
  if (item.ruleId !== null && item.ruleId !== undefined) {
    console.warn(`Attempted to modify auto item ${item.id} - ignoring`);
    return false;
  }
  return true;
});
```

---

### 3. Rule Delete Behavior

**When deleting a rule:**
- ‚úÖ Cascade delete removes all auto items (ruleId = rule.id)
- ‚úÖ Manual items remain (ruleId = null)
- ‚úÖ This is the only way to remove auto items

**No Changes Required:** Current behavior is correct

---

### 4. Manual Items (No Changes)

**Current Behavior:**
- ‚úÖ Manual items are additive (correct)
- ‚úÖ No conflict resolution needed (correct)
- ‚úÖ Manual items can coexist with auto items (correct)

**No Changes Required:** Manual items logic is correct as-is

---

## üìã Implementation Checklist

### Phase 1: Verify UI Behavior
- [ ] Step 1.1: Verify auto items do NOT show delete button
- [ ] Step 1.2: Verify manual items DO show delete button
- [ ] Step 1.3: Test UI to confirm behavior

### Phase 2: Verify API Protection
- [ ] Step 2.1: Verify API only processes manual items (ruleId = null)
- [ ] Step 2.2: Test API with auto items in request (should be ignored)
- [ ] Step 2.3: Verify cascade delete works when rule is deleted

### Phase 3: Add API Protection (If Needed)
- [ ] Step 3.1: Add explicit filtering to reject auto items
- [ ] Step 3.2: Add logging for attempted auto item modifications
- [ ] Step 3.3: Test API protection

### Phase 4: Verify UI Behavior
- [ ] Step 4.1: Verify delete button visibility (auto vs manual)
- [ ] Step 4.2: Add tooltip/message for auto items (optional)
- [ ] Step 4.3: Verify rule delete handler works correctly

### Phase 5: Add User Messaging (Optional)
- [ ] Step 5.1: Add helpful message in UI about auto items
- [ ] Step 5.2: Test user experience

### Phase 6: Testing
- [ ] Test: Attempt to delete auto item via UI ‚Üí should not be possible
- [ ] Test: Attempt to delete auto item via API ‚Üí should be ignored
- [ ] Test: Delete rule ‚Üí verify all auto items deleted
- [ ] Test: Manual item + auto item same year ‚Üí verify both exist (additive)
- [ ] Test: Update rule ‚Üí verify auto items regenerate correctly

---

## üéØ Success Criteria

### Functional Requirements

1. ‚úÖ **Cannot Delete Auto Items**: User cannot delete individual auto items (UI + API protection)
2. ‚úÖ **Delete Rule**: Deleting rule deletes all auto items (existing behavior - correct)
3. ‚úÖ **Manual Items Additive**: Manual items coexist with auto items (existing behavior - correct)
4. ‚úÖ **Clear UX**: User understands that auto items cannot be deleted individually

### Non-Functional Requirements

1. ‚úÖ **Performance**: No performance impact (simplification, not addition)
2. ‚úÖ **Data Integrity**: Auto items only deleted when rule is deleted
3. ‚úÖ **User Experience**: Clear visual distinction between auto and manual items

---

## üö® Critical Notes

1. **Auto items are NOT deletable individually** - only via rule deletion
2. **UI must NOT show delete button** on auto items
3. **API must reject** attempts to delete/modify auto items
4. **Manual items are always additive** - no conflict resolution needed
5. **Rule deletion** is the only way to remove auto items (cascade delete)

---

## üìä Example Scenarios

### Scenario A: User Attempts to Delete Auto Item

**Before:**
- Rule: FURNITURE, 7-year cycle, starting 2028
- Auto items: 2028, 2035, 2042, 2049

**Action:** User looks for delete button on auto item (2035)

**After:**
- No delete button visible on auto item ‚úÖ
- User understands: Cannot delete individual auto items
- User must delete rule to remove auto items

**Result:** Clear UX, no confusion ‚úÖ

---

### Scenario B: User Deletes Rule

**Before:**
- Rule: TECHNOLOGY, 4-year cycle, starting 2028
- Auto items: 2028, 2032, 2036, 2040, 2044, 2048
- Manual items: 2030, TECHNOLOGY, 2M SAR

**Action:** User deletes rule

**After:**
- Rule: Deleted
- Auto items: All deleted (cascade delete)
- Manual items: 2030, TECHNOLOGY, 2M SAR (remains) ‚úÖ

**Result:** All auto items deleted, manual items remain ‚úÖ

---

### Scenario C: Manual Item + Auto Item (Same Year)

**Before:**
- Rule: FURNITURE, 7-year cycle, starting 2028
- Auto item: 2035, FURNITURE, 5M SAR

**Action:** User creates manual item: 2035, FURNITURE, 3M SAR

**After:**
- Auto item: 2035, FURNITURE, 5M SAR (exists, no delete button)
- Manual item: 2035, FURNITURE, 3M SAR (exists, has delete button)
- Total for 2035, FURNITURE: 8M SAR (additive) ‚úÖ

**Result:** Both items exist (additive) ‚úÖ

---

### Scenario D: User Updates Rule

**Before:**
- Rule: FURNITURE, 7-year cycle, base cost 5M SAR
- Auto items: 2028, 2035, 2042, 2049

**Action:** User updates rule: base cost changed to 6M SAR

**After:**
- System recalculates: Deletes all auto items, regenerates with new amounts
- Auto items: 2028, 2035, 2042, 2049 (regenerated with new amounts) ‚úÖ

**Result:** All auto items regenerated (expected behavior) ‚úÖ

---

## üîß Technical Implementation Details

### No Database Changes Required

**Simplification Benefit:**
- ‚úÖ No schema changes needed
- ‚úÖ No migrations required
- ‚úÖ No new fields to track

---

### API Protection Enhancement

**File:** `app/api/versions/[id]/route.ts`

**Key Changes:**
1. Explicitly filter out auto items from requests
2. Log warnings if auto items are attempted to be modified
3. Only process manual items (ruleId = null)

**Code:**
```typescript
// Filter out auto items (ruleId IS NOT NULL)
const manualItemsOnly = data.capexItems.filter((item: any) => {
  if (item.ruleId !== null && item.ruleId !== undefined) {
    console.warn(`Attempted to modify auto item ${item.id} - ignoring`);
    return false;
  }
  return true;
});
```

---

### UI Verification

**File:** `components/versions/VersionDetail.tsx`

**Key Verification:**
1. Auto items should NOT show delete button
2. Manual items should show delete button
3. Clear visual distinction (badge showing "Auto" vs "Manual")

---

## üß™ Testing Requirements

### Test Case 1: Attempt to Delete Auto Item via UI

**Steps:**
1. Create rule: FURNITURE, 7-year cycle, starting 2028
2. Verify auto items generated: 2028, 2035, 2042, 2049
3. Check UI for delete button on auto item (2035)
4. Verify no delete button visible

**Expected:** ‚úÖ No delete button on auto items

---

### Test Case 2: Attempt to Delete Auto Item via API

**Steps:**
1. Create rule with auto items
2. Attempt to send PATCH request with auto item (ruleId IS NOT NULL)
3. Verify API ignores auto item
4. Verify auto item still exists after request

**Expected:** ‚úÖ API rejects/ignores auto item deletion

---

### Test Case 3: Delete Rule

**Steps:**
1. Create rule with auto items
2. Create manual items
3. Delete rule
4. Verify all auto items deleted
5. Verify manual items remain

**Expected:** ‚úÖ Auto items deleted, manual items remain

---

### Test Case 4: Manual + Auto (Same Year)

**Steps:**
1. Create rule: Generates 2035, FURNITURE, 5M SAR (auto)
2. Create manual item: 2035, FURNITURE, 3M SAR
3. Verify both items exist in table
4. Verify auto item has no delete button
5. Verify manual item has delete button
6. Verify total for 2035, FURNITURE = 8M SAR

**Expected:** ‚úÖ Both items exist (additive), correct button visibility

---

### Test Case 5: Update Rule (Recalculation)

**Steps:**
1. Create rule: Generates 2028, 2035, 2042, 2049
2. Update rule: Change base cost
3. Verify recalculation runs
4. Verify all auto items regenerated with new amounts

**Expected:** ‚úÖ All auto items regenerated (expected behavior)

---

## üìù Summary

### What You Want

1. ‚úÖ **Auto Re-investment Rule**: Generates recurring items based on cycle
2. ‚úÖ **Delete Rule**: Deletes all auto items (existing behavior - correct)
3. ‚ùå **NO individual auto item deletion**: Simplification - not possible
4. ‚úÖ **Manual Items**: Additive (no override) - existing behavior correct

### What Needs to Change

1. **Verify UI** does NOT show delete button on auto items
2. **Add API protection** to reject attempts to delete auto items
3. **Add user messaging** (optional) to explain behavior

### What Stays the Same

1. ‚úÖ **Manual items are additive** (no changes needed)
2. ‚úÖ **Delete rule deletes all auto items** (no changes needed)
3. ‚úÖ **Auto items generation logic** (no changes needed)
4. ‚úÖ **Calculation logic** (no changes needed)

---

## üöÄ Implementation Priority

**Phase 1 (Critical):**
- Verify UI behavior (delete button visibility)
- Verify API protection

**Phase 2 (Important):**
- Add explicit API filtering (if not already present)
- Add logging for attempted auto item modifications

**Phase 3 (Optional):**
- Add user messaging/tooltips
- Enhance UX clarity

---

**Estimated Time:** 1-2 hours (mostly verification)

**Risk Level:** üü¢ **LOW** (simplification, no schema changes)

**Status:** ‚úÖ **READY FOR IMPLEMENTATION**

---

**Report Generated:** November 17, 2025  
**Analyst:** AI Assistant  
**Status:** ‚úÖ **ROADMAP COMPLETE - READY FOR IMPLEMENTATION**

