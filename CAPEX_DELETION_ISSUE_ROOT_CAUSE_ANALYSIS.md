# Capex Deletion Issue - Root Cause Analysis Report

**Date:** November 17, 2025  
**Issue:** Automatic Capex items reappear after deletion when rules are recalculated  
**Status:** üî¥ **CRITICAL ISSUE IDENTIFIED**  
**Severity:** High - Data integrity and user experience issue

---

## üìã Executive Summary

When a user creates a Capex rule, the system automatically generates Capex items. Users can delete these auto-generated items, but when the rule is recalculated (e.g., rule updated, version saved), the deleted items are **regenerated**, causing confusion and frustration.

**Root Cause:** The system lacks a mechanism to track user-suppressed auto-generated items. When rules are recalculated, all auto items are regenerated from scratch, ignoring previous user deletions.

**Impact:** Users cannot permanently suppress specific auto-generated Capex items without deleting the entire rule.

---

## üîç Issue Description

### User Experience

1. **User creates a Capex rule** (e.g., FURNITURE, 7-year cycle, starting 2028)
2. **System auto-generates items** for years: 2028, 2035, 2042, 2049
3. **User deletes some items** (e.g., deletes 2035 and 2042)
4. **User updates the rule** (e.g., changes base cost)
5. **System recalculates and regenerates ALL items** including deleted ones (2035, 2042 reappear)
6. **User frustration:** Deleted items come back

### Expected vs. Actual Behavior

| Action | Expected Behavior | Actual Behavior |
|--------|------------------|-----------------|
| Delete auto item | Item stays deleted OR converted to manual override (0 amount) | Item is deleted temporarily |
| Update rule | Only non-deleted items regenerated | ALL items regenerated (deleted ones reappear) |
| Save version | Deleted items remain deleted | Deleted items may reappear |

---

## üìö Requirements Analysis (From PRD)

### PRD Section 4.3 - Tab 4: Capex

**From PRD.md (Lines 1063-1080):**

```yaml
Tab 4: Capex
Purpose: Capital expenditure planning with auto-reinvestment

Features:
- Timeline Chart: Gradient bars showing reinvestment cycles per class
- Edit Modal: Click bar to open drawer with cycle configuration
- Summary Table: All capex items by year with totals
```

**Key Requirement (PRD Lines 2868-2876):**

```yaml
manual_capex_overrides:
  description: "Override auto-calculated capex for specific years"
  per_year: [2023-2052]
  per_class: [Building, FF&E, IT, Other]
  adjustable:
    - amount:
        type: decimal (SAR)
        range: [0, 1000000000]
        default: from base version or auto-calculated
```

**Interpretation:**
- ‚úÖ Manual items should **override** auto-calculated items
- ‚úÖ Users should be able to suppress auto items for specific years
- ‚ùå **MISSING:** Mechanism to suppress auto items (convert to manual override with 0)

---

## üî¨ Root Cause Analysis

### Root Cause #1: No Suppression Mechanism

**Problem:** The system has no way to track which auto-generated items the user wants to suppress.

**Evidence:**
- `capex_items` table has `ruleId` field to distinguish auto vs manual
- When auto items are deleted, there's no record that they were intentionally suppressed
- When rules recalculate, all items are regenerated from scratch

**Code Location:**
- `services/capex/calculate.ts` (Lines 37-43): Deletes ALL auto items before regenerating
- `app/api/versions/[id]/route.ts` (Lines 978-987): Triggers recalculation on rule update

**Impact:** Deleted auto items will always reappear when rules are recalculated.

---

### Root Cause #2: Deletion Logic Allows Auto Items

**Problem:** The UI allows deletion of auto-generated items, but this is a temporary action.

**Evidence:**
- `components/versions/VersionDetail.tsx` (Line 1962): Checks `isAutoGenerated = item.ruleId !== null`
- Line 1989: Only manual items show edit/delete buttons (correct)
- BUT: If auto items somehow become deletable, deletion is permanent in database but temporary in practice

**Code Location:**
- `components/versions/VersionDetail.tsx` (Lines 974-1045): `handleCapexDelete` function
- `app/api/versions/[id]/route.ts` (Lines 1015-1037): Manual items deletion logic

**Impact:** Users can delete auto items, but they will reappear on next recalculation.

---

### Root Cause #3: Recalculation Regenerates All Items

**Problem:** When a rule is updated, the system deletes ALL auto items and regenerates them, ignoring previous deletions.

**Evidence:**
- `services/capex/calculate.ts` (Lines 37-43):
  ```typescript
  // Delete existing auto-generated items (where ruleId IS NOT NULL)
  await prisma.capex_items.deleteMany({
    where: {
      versionId,
      ruleId: { not: null },
    },
  });
  ```
- This deletes ALL auto items, including ones the user may have wanted to keep deleted

**Code Location:**
- `services/capex/calculate.ts` (Lines 17-68): `calculateAndPersistCapexItems` function
- `app/api/versions/[id]/route.ts` (Lines 963-987): Rule update triggers recalculation

**Impact:** Any user deletions of auto items are lost when rules are recalculated.

---

### Root Cause #4: Missing "Override" Concept

**Problem:** The system doesn't implement the PRD requirement for "manual overrides" that suppress auto items.

**Expected Behavior (from PRD):**
- User should be able to create a manual item with amount = 0 to suppress an auto item
- OR: System should track suppressed years per rule
- OR: Auto items should be "convertible" to manual overrides

**Current Behavior:**
- Manual items and auto items are separate
- No mechanism to suppress specific auto items permanently

**Impact:** Users cannot achieve the desired state (suppress specific auto items).

---

## üìä Data Flow Analysis

### Current Flow (Problematic)

```
1. User creates rule
   ‚Üì
2. System generates auto items (2028, 2035, 2042, 2049)
   ‚Üì
3. User deletes item for 2035
   ‚Üì
4. Database: Item deleted (ruleId = 'xxx', year = 2035) ‚ùå DELETED
   ‚Üì
5. User updates rule (e.g., changes base cost)
   ‚Üì
6. System recalculates:
   - Deletes ALL auto items (including 2028, 2042, 2049 that user kept)
   - Regenerates ALL items (2028, 2035, 2042, 2049) ‚ùå 2035 REAPPEARS
   ‚Üì
7. Result: Deleted item (2035) is back ‚ùå
```

### Expected Flow (From PRD)

```
1. User creates rule
   ‚Üì
2. System generates auto items (2028, 2035, 2042, 2049)
   ‚Üì
3. User wants to suppress 2035
   ‚Üì
4. System creates manual override (year = 2035, amount = 0, ruleId = null)
   OR: System marks 2035 as suppressed in rule metadata
   ‚Üì
5. User updates rule
   ‚Üì
6. System recalculates:
   - Regenerates auto items (2028, 2035, 2042, 2049)
   - BUT: Checks for manual overrides or suppressed years
   - Skips 2035 (suppressed) OR uses manual override (amount = 0)
   ‚Üì
7. Result: 2035 remains suppressed ‚úÖ
```

---

## üéØ Requirements Gap Analysis

### What PRD Requires

1. **Manual Overrides** (PRD Line 2868):
   - "Override auto-calculated capex for specific years"
   - Should allow suppressing auto items

2. **Separation of Auto vs Manual**:
   - Auto items: Generated from rules
   - Manual items: User-created overrides

3. **Persistence of User Intent**:
   - If user suppresses an auto item, it should stay suppressed

### What Current Implementation Provides

1. ‚úÖ **Auto Items Generation**: Works correctly
2. ‚úÖ **Manual Items Creation**: Works correctly
3. ‚ùå **Suppression Mechanism**: **MISSING**
4. ‚ùå **Override Logic**: **MISSING**
5. ‚ùå **Persistence of Deletions**: **MISSING**

---

## üîç Code Analysis

### File 1: `services/capex/calculate.ts`

**Lines 37-43:**
```typescript
// Delete existing auto-generated items (where ruleId IS NOT NULL)
await prisma.capex_items.deleteMany({
  where: {
    versionId,
    ruleId: { not: null },
  },
});
```

**Issue:** Deletes ALL auto items, including ones user may have wanted to keep.

**Fix Required:** Only delete auto items that are NOT suppressed/overridden.

---

### File 2: `app/api/versions/[id]/route.ts`

**Lines 963-987:**
```typescript
// Trigger auto-calculation to generate CapexItems from rules
const calcResult = await calculateAndPersistCapexItems(
  id,
  rulesForCalculation,
  cpiRate
);
```

**Issue:** Recalculates all items without checking for suppressed years.

**Fix Required:** Pass suppressed years or manual overrides to calculation function.

---

### File 3: `components/versions/VersionDetail.tsx`

**Lines 1962-2016:**
```typescript
const isAutoGenerated = item.ruleId !== null && item.ruleId !== undefined;
// ...
{!isAutoGenerated && (
  // Edit/Delete buttons only for manual items
)}
```

**Issue:** Auto items cannot be deleted from UI (correct), but if they could be, deletion wouldn't persist.

**Fix Required:** Add "Suppress" or "Convert to Manual Override" functionality for auto items.

---

## üí° Solution Options

### Option 1: Manual Override with Zero Amount (Recommended)

**Approach:**
- When user wants to suppress an auto item, create a manual item with `amount = 0` and same `year`/`category`
- During recalculation, check for manual overrides and skip auto items where manual override exists

**Pros:**
- ‚úÖ Aligns with PRD requirement for "manual overrides"
- ‚úÖ Simple implementation
- ‚úÖ Clear user intent (manual item = override)

**Cons:**
- ‚ö†Ô∏è Shows "0" amount in table (could be confusing)
- ‚ö†Ô∏è Requires UI change to allow "suppress" action on auto items

**Implementation:**
1. Add "Suppress" button on auto items (converts to manual override with 0)
2. Modify `calculateAndPersistCapexItems` to check for manual overrides before creating auto items
3. If manual override exists for same year/category, skip auto item generation

---

### Option 2: Suppressed Years in Rule Metadata

**Approach:**
- Add `suppressedYears: number[]` field to `capex_rules` table
- Store suppressed years in rule metadata
- During recalculation, skip suppressed years

**Pros:**
- ‚úÖ Clean separation (suppression is rule-level)
- ‚úÖ No zero-amount items in table

**Cons:**
- ‚ö†Ô∏è Requires schema change (migration)
- ‚ö†Ô∏è More complex logic
- ‚ö†Ô∏è Not aligned with PRD "manual overrides" concept

**Implementation:**
1. Add `suppressedYears` JSON field to `capex_rules`
2. Add UI to mark years as suppressed
3. Modify calculation to skip suppressed years

---

### Option 3: Soft Delete with Flag

**Approach:**
- Add `isSuppressed: boolean` field to `capex_items` table
- When user "deletes" auto item, set `isSuppressed = true` instead of deleting
- During recalculation, check for suppressed items and skip regeneration

**Pros:**
- ‚úÖ Preserves user intent
- ‚úÖ Simple logic

**Cons:**
- ‚ö†Ô∏è Requires schema change (migration)
- ‚ö†Ô∏è Suppressed items still in database (could be confusing)
- ‚ö†Ô∏è Not aligned with PRD "manual overrides" concept

---

## üéØ Recommended Solution

**Option 1: Manual Override with Zero Amount** is recommended because:

1. ‚úÖ **Aligns with PRD**: PRD explicitly mentions "manual overrides"
2. ‚úÖ **No Schema Change**: Uses existing `ruleId = null` for manual items
3. ‚úÖ **Clear User Intent**: Manual item = user override
4. ‚úÖ **Simple Implementation**: Minimal code changes

### Implementation Steps

1. **UI Change**: Add "Suppress" button on auto items
   - Converts auto item to manual override (amount = 0, ruleId = null)
   - User can later edit manual override to set custom amount

2. **Calculation Logic Change**: Modify `calculateAndPersistCapexItems`
   - Before creating auto item, check if manual override exists (same year/category)
   - If override exists, skip auto item generation
   - If override has amount = 0, it suppresses the auto item

3. **Display Logic**: Show suppressed items as "Suppressed" or "Override (0)" in table

---

## üìã Detailed Requirements

### Functional Requirements

1. **Suppress Auto Item**:
   - User clicks "Suppress" on auto item
   - System creates manual item: `{ year, category, amount: 0, ruleId: null }`
   - Auto item is removed from display
   - Manual override (0) is shown

2. **Recalculation Behavior**:
   - When rule recalculates, check for manual overrides
   - If manual override exists for year/category:
     - Skip auto item generation
     - Keep manual override (even if amount = 0)

3. **Edit Suppressed Item**:
   - User can edit manual override (0 amount)
   - Can set custom amount
   - Can delete manual override (restores auto item)

4. **Display**:
   - Show "Suppressed" badge for manual items with amount = 0
   - OR: Show "Override (0)" in description
   - OR: Hide suppressed items with toggle option

---

## üîç Additional Findings

### Issue: UI Shows Both Manual and Auto Items

**Current State:**
- Table shows all items (auto + manual)
- Source column shows "Auto" or "Manual"
- Only manual items have edit/delete buttons

**Problem:**
- User cannot suppress auto items from UI
- If auto items could be deleted, deletion wouldn't persist

**Fix Required:**
- Add "Suppress" button on auto items
- OR: Add "Convert to Manual Override" button

---

### Issue: No Conflict Resolution

**Scenario:**
- Rule generates auto item: Year 2035, FURNITURE, 5M SAR
- User creates manual item: Year 2035, FURNITURE, 3M SAR
- Both items exist in table

**Question:** Should manual item override auto item, or should both be shown?

**Current Behavior:** Both items are shown (potential duplicate/confusion)

**Expected Behavior (from PRD):** Manual item should override auto item (only one shown)

**Fix Required:** During recalculation, if manual override exists, skip auto item for that year/category.

---

## üìä Impact Assessment

### User Impact

- **High Frustration**: Deleted items reappearing
- **Loss of Trust**: System doesn't respect user actions
- **Workaround Required**: Users must delete entire rule to suppress items

### Data Integrity

- **Low Risk**: No data corruption
- **Medium Risk**: Inconsistent state (deleted items reappear)

### Business Impact

- **Medium**: Users may avoid using auto rules
- **High**: Manual workarounds increase time spent

---

## ‚úÖ Verification Checklist

After implementing fix, verify:

- [ ] User can suppress auto items (converts to manual override)
- [ ] Suppressed items stay suppressed after rule recalculation
- [ ] Manual overrides (amount > 0) work correctly
- [ ] Manual overrides (amount = 0) suppress auto items
- [ ] User can edit suppressed items (change amount from 0)
- [ ] User can delete manual override (restores auto item)
- [ ] No duplicate items (manual override + auto item for same year/category)
- [ ] Display clearly shows suppressed state

---

## üö® Critical Notes

1. **Do NOT allow deletion of auto items directly** - Always convert to manual override
2. **Recalculation must check for manual overrides** - Skip auto items where override exists
3. **Manual override with amount = 0 = suppression** - This is the key concept
4. **UI must clearly indicate suppressed state** - User should understand what "Suppressed" means

---

## üìù Summary

**Root Cause:** System lacks mechanism to persist user suppression of auto-generated Capex items. When rules recalculate, all auto items are regenerated, ignoring previous deletions.

**Solution:** Implement manual override mechanism where suppressing an auto item creates a manual item with amount = 0. During recalculation, skip auto items where manual overrides exist.

**Priority:** High - Affects core functionality and user experience

**Estimated Fix Time:** 4-6 hours (UI changes + calculation logic update)

---

**Report Generated:** November 17, 2025  
**Analyst:** AI Assistant  
**Status:** ‚úÖ **READY FOR IMPLEMENTATION**

